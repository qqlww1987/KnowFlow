#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo -e "${BLUE}ğŸš€ KnowFlow å®‰è£…è„šæœ¬${NC}"
echo "=================================="

# æ£€æŸ¥Pythonç‰ˆæœ¬
check_python_version() {
    echo -e "${YELLOW}ğŸ“‹ æ£€æŸ¥Pythonç‰ˆæœ¬...${NC}"
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
        echo -e "${GREEN}âœ… Pythonç‰ˆæœ¬: $PYTHON_VERSION${NC}"
    else
        echo -e "${RED}âŒ æœªæ‰¾åˆ°Python3ï¼Œè¯·å…ˆå®‰è£…Python 3.8+${NC}"
        exit 1
    fi
}

# æ£€æŸ¥å¹¶åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
setup_virtual_environment() {
    echo -e "${YELLOW}ğŸ“¦ è®¾ç½®è™šæ‹Ÿç¯å¢ƒ...${NC}"
    
    if [ ! -d "$PROJECT_ROOT/server/venv" ]; then
        echo "åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
        cd "$PROJECT_ROOT/server"
        python3 -m venv venv
        echo -e "${GREEN}âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸ${NC}"
    else
        echo -e "${GREEN}âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨${NC}"
    fi
}

# å®‰è£…Pythonä¾èµ–
install_python_dependencies() {
    echo -e "${YELLOW}ğŸ“¦ å®‰è£…Pythonä¾èµ–...${NC}"
    
    cd "$PROJECT_ROOT/server"
    source venv/bin/activate
    
    echo "å‡çº§pip..."
    pip install --upgrade pip
    
    echo "å®‰è£…ä¾èµ–åŒ…..."
    pip install -r requirements.txt
    
    echo -e "${GREEN}âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ${NC}"
}

# æ£€æŸ¥å¹¶åˆ›å»º.envæ–‡ä»¶
setup_env_file() {
    echo -e "${YELLOW}âš™ï¸  æ£€æŸ¥ç¯å¢ƒé…ç½®...${NC}"
    
    if [ ! -f "$PROJECT_ROOT/.env" ]; then
        echo "åˆ›å»º.envæ–‡ä»¶..."
        cat > "$PROJECT_ROOT/.env" << EOF
# RAGFlow é…ç½®
RAGFLOW_BASE_URL=http://localhost:9380

# æ•°æ®åº“é…ç½®
MYSQL_PASSWORD=infini_rag_flow
MINIO_USER=rag_flow
MINIO_PASSWORD=infini_rag_flow
ELASTIC_PASSWORD=infini_rag_flow

# å¼€å‘æ¨¡å¼é…ç½®
DEV_MODE=true
SKIP_MINERU_PROCESSING=true
EOF
        echo -e "${GREEN}âœ… .envæ–‡ä»¶åˆ›å»ºæˆåŠŸ${NC}"
        echo -e "${YELLOW}âš ï¸  è¯·æ ¹æ®ä½ çš„å®é™…é…ç½®ä¿®æ”¹.envæ–‡ä»¶${NC}"
    else
        echo -e "${GREEN}âœ… .envæ–‡ä»¶å·²å­˜åœ¨${NC}"
    fi
}

# æ£€æŸ¥DockeræœåŠ¡
check_docker_services() {
    echo -e "${YELLOW}ğŸ³ æ£€æŸ¥DockeræœåŠ¡...${NC}"
    
    # æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
    if ! docker info > /dev/null 2>&1; then
        echo -e "${RED}âŒ Dockeræœªè¿è¡Œï¼Œè¯·å¯åŠ¨Docker${NC}"
        return 1
    fi
    
    # æ£€æŸ¥å¿…è¦çš„å®¹å™¨
    local containers=("ragflow-ragflow-1" "ragflow-mysql-1" "ragflow-minio-1" "ragflow-elasticsearch-1")
    local missing_containers=()
    
    for container in "${containers[@]}"; do
        if ! docker ps --format "{{.Names}}" | grep -q "^${container}$"; then
            missing_containers+=("$container")
        fi
    done
    
    if [ ${#missing_containers[@]} -eq 0 ]; then
        echo -e "${GREEN}âœ… æ‰€æœ‰å¿…è¦çš„Dockerå®¹å™¨éƒ½åœ¨è¿è¡Œ${NC}"
        return 0
    else
        echo -e "${YELLOW}âš ï¸  ä»¥ä¸‹å®¹å™¨æœªè¿è¡Œ:${NC}"
        for container in "${missing_containers[@]}"; do
            echo "  - $container"
        done
        echo -e "${YELLOW}è¯·ç¡®ä¿RAGFlowæœåŠ¡å·²å¯åŠ¨${NC}"
        return 1
    fi
}

# æ˜¾ç¤ºé…ç½®è¯´æ˜
show_config_instructions() {
    echo -e "${BLUE}ğŸ“– é…ç½®è¯´æ˜${NC}"
    echo "=================================="
    echo "è¯·ç¡®ä¿ä»¥ä¸‹æœåŠ¡å·²æ­£ç¡®é…ç½®ï¼š"
    echo ""
    echo "  1. RAGFLOW_BASE_URL - RAGFlowæœåŠ¡åœ°å€"
    echo "  2. æ•°æ®åº“è¿æ¥é…ç½® - MySQLã€MinIOã€Elasticsearch"
    echo ""
    echo "å¦‚æœéœ€è¦ä¿®æ”¹é…ç½®ï¼Œè¯·ç¼–è¾‘ .env æ–‡ä»¶ï¼š"
    echo "  nano .env"
    echo ""
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage_instructions() {
    echo -e "${BLUE}ğŸš€ å¯åŠ¨è¯´æ˜${NC}"
    echo "=================================="
    echo "å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥ï¼š"
    echo ""
    echo "1. å¯åŠ¨KnowFlowæœåŠ¡ï¼š"
    echo "   cd server && source venv/bin/activate && python app.py"
    echo ""
    echo "2. è®¿é—®Webç•Œé¢ï¼š"
    echo "   http://localhost:5000"
    echo ""
    echo "3. æŸ¥çœ‹APIæ–‡æ¡£ï¼š"
    echo "   http://localhost:5000/docs"
    echo ""
}

# ä¸»å®‰è£…æµç¨‹
main() {
    echo -e "${BLUE}å¼€å§‹å®‰è£…KnowFlow...${NC}"
    echo ""
    
    check_python_version
    setup_virtual_environment
    install_python_dependencies
    setup_env_file
    
    echo ""
    echo -e "${GREEN}ğŸ‰ KnowFlowå®‰è£…å®Œæˆï¼${NC}"
    echo ""
    
    show_config_instructions
    show_usage_instructions
    
    echo -e "${YELLOW}âš ï¸  æ³¨æ„ï¼šè¯·ç¡®ä¿RAGFlowæœåŠ¡å·²å¯åŠ¨å¹¶å¯ä»¥è®¿é—®${NC}"
}

# è¿è¡Œä¸»å‡½æ•°
main
