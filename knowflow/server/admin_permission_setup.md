# 管理员权限控制系统 - 部署和使用说明

## 概述

本次更新为 KnowFlow 系统添加了管理员权限控制功能，实现了以下核心需求：

1. **管理员也可以访问管理菜单**
2. **数据隔离**：管理员只能查看到自己创建的用户、团队、文件、知识库、用户配置
3. **层级管理**：管理员可以管理自己创建的用户及其产生的数据

## 角色权限说明

### 超级管理员 (super_admin)
- 可以查看和管理所有数据
- 拥有系统最高权限
- 不受数据过滤限制

### 管理员 (admin) 
- 可以访问管理菜单（用户管理、团队管理、知识库管理、文件管理、用户配置）
- **用户管理/用户配置**：只能看到自己创建的用户 + 自己
- **团队管理/知识库管理**：只能看到自己创建的资源  
- **文件管理**：可以看到自己 + 下属用户创建的所有文件

### 普通用户 (user)
- 只能看到自己的数据
- 无法访问管理菜单

## 部署步骤

### 1. 执行数据库迁移

```bash
# 连接到MySQL数据库
mysql -u your_username -p your_database

# 执行迁移脚本
source knowflow/server/migrations/add_created_by_fields.sql
```

### 2. 重启后端服务

```bash
# 重启 KnowFlow 后端服务
cd knowflow/server
python app.py

# 或者如果使用Docker
docker-compose restart knowflow-server
```

### 3. 重启前端服务

```bash
# 重启前端服务
cd web
pnpm dev

# 或者如果使用Docker  
docker-compose restart knowflow-web
```

## 使用说明

### 创建管理员用户

1. **通过超级管理员创建**：
   - 超级管理员登录系统
   - 进入"系统管理" -> "用户管理" 
   - 创建新用户并分配 `admin` 角色

2. **通过 RBAC 系统分配角色**：
   ```bash
   # 使用 RBAC 初始化脚本
   cd knowflow/server
   python rbac_init.py
   ```

### 管理员使用流程

1. **登录系统**
   - 管理员使用分配的账号密码登录

2. **访问管理功能**
   - 登录后可以看到"系统管理"菜单
   - 包含：用户管理、团队管理、文件管理、知识库管理、用户配置

3. **数据可见性**
   - **自己创建的用户**：在用户管理中显示
   - **自己创建的团队**：在团队管理中显示
   - **自己和下属用户的文件**：在文件管理中显示
   - **自己创建的知识库**：在知识库管理中显示
   - **自己和下属用户的配置**：在用户配置中显示

## 技术实现详情

### 后端权限控制

1. **用户身份识别**：
   - Flask g 对象存储当前用户信息
   - 支持从 header/cookie 获取用户ID
   - 数据库查询用户角色信息

2. **数据过滤逻辑**：
   ```python
   # 管理员用户查询
   WHERE (created_by = %admin_id OR id = %admin_id)
   
   # 管理员资源查询  
   WHERE created_by = %admin_id
   
   # 管理员文件查询
   WHERE created_by IN (管理员可管理的用户ID列表)
   ```

3. **服务层修改**：
   - `get_users_with_pagination()` - 添加创建者过滤
   - `get_teams_with_pagination()` - 添加创建者过滤  
   - `get_knowledgebase_list()` - 添加创建者过滤
   - `get_files_list()` - 添加用户层级过滤

### 前端权限控制

1. **动态路由**：
   - 管理页面移至 `dynamicRoutes`
   - 设置角色要求：`["admin", "super_admin"]`

2. **菜单显示**：
   - 基于用户角色动态显示管理菜单
   - 权限不足时自动隐藏

## 注意事项

1. **数据一致性**：
   - 现有数据的 `created_by` 字段为 NULL
   - 建议在迁移后手动设置重要数据的创建者

2. **向后兼容**：
   - 保留了超级管理员的完整权限
   - 未指定角色的用户默认为普通用户

3. **安全考虑**：
   - 管理员无法看到其他管理员创建的数据
   - 数据过滤在服务层实施，确保安全性

## 故障排除

### 管理员看不到管理菜单
- 检查用户是否有 `admin` 角色
- 确认前端动态路由功能已启用
- 检查 `/me` 接口返回的角色信息

### 数据过滤不生效  
- 确认数据库迁移已执行
- 检查服务函数是否传递了用户信息参数
- 验证 Flask g 对象中的用户信息

### 权限过于严格
- 检查 `created_by` 字段是否正确设置
- 确认用户角色分配正确
- 验证可管理用户ID列表的生成逻辑

## 联系支持

如遇到问题，请提供以下信息：
- 用户角色和ID
- 具体的错误信息或现象
- 相关的日志输出
- 数据库中相关表的数据状态