# 背景
1. 本项目是一个 RAG 系统，/Users/zxwei/zhishi/KnowFlow/knowflow 是独立的微服务，提供 rbac http server 端实现给到主项目使用，如果需要用到该目录下的服务，需要通过  source /Users/zxwei/zhishi/KnowFlow/knowflow/server/venv/bin/activate ，然后 python3.10 来执行脚本。


2. 主项目前端在 /Users/zxwei/zhishi/KnowFlow/web 下面，其他目录都是主项目后端服务。
后端项目可以通过 uv run python3.10 执行脚本。


3. 主项目提供了一个管理页面，只允许超级管理员可见和操作。


4. RBAC 服务端端口是 5000，主项目端口是 9380，主项目的数据库端口是 5545。


5 . 分析下 knowflow 已有的几个分块策略，正则，AST 结构分块等。现在在上述基础上，对 MinerU 解析方法新增 Markdown 父子模块策略：

    与通用模式相比，父子模式采用双层分段结构来平衡检索的精确度和上下文信息,让精准匹配与全面的上下文信息二者兼得。
    其中，父区块（Parent-chunk）保持较大的文本单位（如段落），提供丰富的上下文信息；子区块（Child-chunk）则是较小的文本单位（如句子），用于精确检索。系统首先通过子区块进行精确检索以确保相关性，然后获取对应的父区块来补充上下文信息，从而在生成响应时既保证准确性又能提供完整的背景信息。你可以通过设置分隔符和最大长度来自定义父子区块的分段方式。
    例如在 AI 智能客服场景下，用户输入的问题将定位至解决方案文档内某个具体的句子，随后将该句子所在的段落或章节，联同发送至 LLM，补全该问题的完整背景信息，给出更加精准的回答。
    其基本机制包括：
    子分段匹配查询：
    将文档拆分为较小、集中的信息单元（例如一句话），更加精准的匹配用户所输入的问题。
    子分段能快速提供与用户需求最相关的初步结果。
    父分段提供上下文：
    将包含匹配子分段的更大部分（如段落、章节甚至整个文档）视作父分段并提供给大语言模型（LLM）。
    父分段能为 LLM 提供完整的背景信息，避免遗漏重要细节，帮助 LLM 输出更贴合知识库内容的回答。
    父子召回原理图
    在该模式下，你需要根据不同的文档格式或场景要求，手动分别设置父子分段的分段规则。
    父分段：
    父分段设置提供以下分段选项：
    段落
    根据预设的分隔符规则和最大块长度将文本拆分为段落。每个段落视为父分段，适用于文本量较大，内容清晰且段落相对独立的文档。支持以下设置项：
    分段标识符，默认值为 \n，即按照文本段落分段。你可以遵循正则表达式语法自定义分块规则，系统将在文本出现分段标识符时自动执行分段。
    分段最大长度，指定分段内的文本字符数最大上限，超出该长度时将强制分段。默认值为 500 Tokens，分段长度的最大上限为 4000 Tokens；
    全文
    不进行段落分段，而是直接将全文视为单一父分段。出于性能原因，仅保留文本内的前 10000 Tokens 字符，适用于文本量较小，但段落间互有关联，需要完整检索全文的场景。
    父子模式下的段落和全文预览
    子分段：
    子分段文本是在父文本分段基础上，由分隔符规则切分而成，用于查找和匹配与问题关键词最相关和直接的信息。如果使用默认的子分段规则，通常呈现以下分段效果：
    当父分段为段落时，子分段对应各个段落中的单个句子。
    父分段为全文时，子分段对应全文中各个单独的句子。
    在子分段内填写以下分段设置：
    分段标识符，默认值为 ，即按照句子进行分段。你可以遵循正则表达式语法自定义分块规则，系统将在文本出现分段标识符时自动执行分段。
    分段最大长度，指定分段内的文本字符数最大上限，超出该长度时将强制分段。默认值为 200 Tokens，分段长度的最大上限为 4000 Tokens；
    你还可以使用文本预处理规则过滤知识库内部分无意义的内容：
    替换连续的空格、换行符和制表符
    删除所有 URL 和电子邮件地址
    配置完成后，点击”预览区块”即可查看分段后的效果。你可以查看父分段的整体字符数。背景标蓝的字符为子分块，同时显示当前子段的字符数。
    如果重新修改了分段规则，需要重新点击”预览区块”按钮以查看新的内容分段。若同时批量上传了多个文档，轻点顶部的文档标题，快速切换至其它文档并预览内容的分段效果。
    父子分段模式
    为了确保内容检索的准确性，父子分段模式仅支持使用”高质量索引”。


采用 langchain ParentDocumentRetreiver 成熟框架实现，服务直接在 ragflow 进行实现，模块化设计，复用 ragflow 已有的数据库，存储机制，向量机制，分句分段都要复用已有的，不要自创。