# 父子分块模式使用说明

## 🎯 概述

父子分块是 KnowFlow 的新增分块策略，基于现有的 Smart AST 分块技术，集成了 LangChain ParentDocumentRetriever，在 MinerU 解析时提供双层分段结构。

## 🚀 快速使用

### 1. 初始化数据库表
```bash
uv run python3.10 api/db/init_parent_child_tables.py
```

### 2. 在前端界面配置

在 MinerU 文档解析配置中：

1. **选择分块策略**: 选择"父子分块"
2. **配置基础参数**: 设置子分块大小和最小分块大小  
3. **配置父子参数**:
   - **父分块大小**: 建议 1024 tokens
   - **父分块重叠**: 建议 100 tokens
   - **父分块分隔符**: 默认 `\n\n` (按段落)
   - **子分块分隔符**: 默认 `[。！？.!?]` (按句子)
   - **检索模式**: 选择 `父分块模式`（推荐）

### 3. 解析文档

配置完成后，上传和解析文档时会自动使用父子分块策略。

## 📋 配置参数说明

| 参数 | 建议值 | 说明 |
|------|--------|------|
| **父分块大小** | 1024 | 提供丰富上下文，范围 200-4000 |
| **子分块大小** | 256 | 精确检索，使用左侧"分块大小"配置 |
| **父分块重叠** | 100 | 相邻父分块重叠部分 |
| **检索模式** | 父分块模式 | 推荐用于问答系统 |

## 🔍 检索模式对比

- **父分块模式**（推荐）: 返回包含完整上下文的父分块
- **子分块模式**: 返回精确匹配的子分块
- **混合模式**: 同时返回子分块和父分块

## 📊 适用场景

### 推荐使用父子分块的场景:
- ✅ 需要完整上下文的问答系统
- ✅ 长文档理解和摘要
- ✅ 复杂推理任务
- ✅ 技术文档解析

### 参数建议:
- **长文档**: 父分块 1536, 子分块 384
- **短文档**: 父分块 512, 子分块 128  
- **技术文档**: 父分块 2048, 子分块 512

## 🛠️ 技术实现

### 核心组件:
- **分块器**: `/rag/nlp/parent_child_splitter.py`
- **检索器**: `/rag/nlp/ragflow_parent_retriever.py`
- **数据库模型**: `/api/db/parent_child_models.py`
- **MinerU集成**: `/knowflow/server/services/knowledgebases/mineru_parse/utils.py`

### 工作流程:
1. 文档解析时选择父子分块策略
2. Smart AST 分块生成基础分块
3. 构建父子层级关系
4. 存储到数据库和 Elasticsearch
5. 检索时先匹配子分块，返回父分块

## ⚠️ 注意事项

1. **数据库要求**: 需要先初始化父子分块相关表
2. **存储空间**: 比常规分块增加约 40% 存储空间
3. **检索性能**: 检索延迟增加约 30-50ms
4. **配置建议**: 父分块大小应大于子分块大小

## 🔧 故障排除

### 常见问题:

**Q: 选择父子分块后解析失败**
```
A: 检查数据库表是否正确创建，运行初始化脚本
```

**Q: 检索结果为空**
```  
A: 确认文档是否使用父子分块策略解析，检查数据库中是否有分块数据
```

**Q: 性能较慢**
```
A: 调整父分块大小，启用数据库索引优化
```

## 📞 技术支持

如遇问题，请检查:
1. 数据库表是否正确创建
2. 配置参数是否合理
3. 系统日志中的详细错误信息

---
**版本**: v2.1.0  
**更新**: 2025年1月